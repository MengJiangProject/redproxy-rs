FROM ghcr.io/astral-sh/uv:debian

# Install system dependencies needed for testing
RUN apt-get update && apt-get install -y \
    openssl \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Create user and set up directories
ARG UID=1000
ARG GID=1000
RUN groupadd -g ${GID} testuser 2>/dev/null || true
RUN useradd -u ${UID} -g ${GID} -m -s /bin/false testuser 2>/dev/null || true
USER testuser

# Set up virtual environment in a location that won't be overridden
ENV UV_PROJECT_ENVIRONMENT=/home/testuser/.venv
# Copy project files to a permanent location for uv project setup
COPY --chown=testuser:testuser scripts/pyproject.toml scripts/uv.lock* /home/testuser/project/
WORKDIR /home/testuser/project
RUN uv sync

# Keep working directory in project for uv commands

# Default command - will be overridden by docker-compose
CMD ["bash", "-c", "echo 'Please specify TEST_SUITE environment variable'; exit 1"]